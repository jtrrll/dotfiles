---
name: Update Automated Pull Requests

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update-pull-requests:
    name: Update automated pull requests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Update pull requests with automated label
        env:
          GH_TOKEN: ${{ secrets.PR_BOT_PERSONAL_ACCESS_TOKEN }}
        run: |
          prs=$(gh pr list --label automated --json number,headRefName,baseRefName --jq '.[] | "\(.number)|\(.headRefName)|\(.baseRefName)"')

          if [ -z "$prs" ]; then
            echo "No automated pull requests to update"
            exit 0
          fi

          echo "$prs" | while IFS='|' read -r pr_number branch base_branch; do
            echo "Updating PR #$pr_number (merging $base_branch into $branch)"

            # Reset to a clean state for each PR
            git checkout main 2>/dev/null || git checkout -b main origin/main
            git branch -D "$branch" 2>/dev/null || true

            # Fetch and checkout with error handling
            if ! git fetch origin "$base_branch"; then
              echo "Failed to fetch $base_branch for PR #$pr_number. Skipping."
              continue
            fi

            if ! git fetch origin "$branch"; then
              echo "Failed to fetch $branch for PR #$pr_number. Skipping."
              continue
            fi

            if ! git checkout -b "$branch" "origin/$branch"; then
              echo "Failed to checkout $branch for PR #$pr_number. Skipping."
              continue
            fi

            if git merge "origin/$base_branch" --no-edit --allow-unrelated-histories; then
              echo "Successfully merged $base_branch into $branch"
              git push origin "$branch"
            else
              echo "Merge conflict detected for PR #$pr_number. Skipping automatic update."
              git merge --abort || true
            fi
          done
